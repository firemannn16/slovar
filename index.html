<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Арабско-русский словарь</title>
<style>
  body { font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background:#f3f4f6; margin:0; padding:24px; color:#0f172a }
  .container { max-width:900px; margin:0 auto; background:#fff; padding:20px; border-radius:12px; box-shadow:0 8px 30px rgba(2,6,23,0.08) }
  h1 { margin:0 0 8px 0; font-size:20px }
  p.lead { margin:0 0 16px 0; color:#475569; font-size:13px }
  input[type="search"] { width:100%; padding:10px 12px; border-radius:8px; border:1px solid #e2e8f0; font-size:16px; box-sizing:border-box }
  .controls { display:flex; gap:8px; margin-top:12px; align-items:center }
  button { padding:8px 12px; border-radius:8px; border:1px solid #cbd5e1; background:#fff; cursor:pointer }
  .count { color:#64748b; font-size:13px }
  ul.results { list-style:none; padding:0; margin:12px 0 0 0; display:grid; gap:8px }
  li.item { padding:12px; border-radius:10px; border:1px solid #e6eef8; background:#fbfdff; cursor:pointer; display:flex; justify-content:space-between; align-items:center }
  li.item:hover { box-shadow:0 6px 18px rgba(2,6,23,0.06) }
  .ru { font-weight:600 }
  .ar { margin-top:6px; font-size:18px; direction:rtl; text-align:right }
  .modal { position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(2,6,23,0.5) }
  .card { background:#fff; padding:18px; border-radius:10px; max-width:720px; width:94% }
  .note { color:#475569; margin-top:8px; font-size:13px }
  small.hint { color:#94a3b8; font-size:12px }
  .file-input { display:flex; gap:8px; align-items:center }
  .footer { margin-top:14px; font-size:12px; color:#64748b }
  .muted { color:#94a3b8 }
  .copybtn { margin-left:8px }
</style>
</head>
<body>
  <div class="container">
    <h1>Арабско-русский словарь</h1>
    <p class="lead">Ищите по арабскому (с огласовками и без) и по-русски. Положите <code>words.txt</code> рядом с этим файлом в репозитории — он подхватится автоматически.</p>

    <input id="q" type="search" placeholder="Введите арабское (مثال: بَيْت или بيت) или русское (дом)..." />

    <div class="controls">
      <div class="file-input">
        <label for="file">Загрузить локальный words.txt</label>
        <input id="file" type="file" accept=".txt" />
        <button id="reload">Загрузить / Перезагрузить из words.txt</button>
      </div>
      <div style="flex:1"></div>
      <div class="count" id="count">Найдено: 0</div>
    </div>

    <ul class="results" id="results"></ul>

    <div class="footer">
      <div class="muted">Форматы в words.txt (одна запись на строку):</div>
      <ul>
        <li><code>Русский(перевод) - арабский_с_огласовками - арабский_без</code> — пример: <code>дом(house) - بَيْت - بيت</code></li>
        <li><code>ru|gloss|ar1|ar2|note</code> — pipe-разделитель: <code>кот|cat|قِطّ|قط|животное</code></li>
        <li>таб\-разделённые столбцы: <code>море[TAB]بَحْرٌ[TAB]بحر</code></li>
        <li>Пустые строки и строки, начинающиеся с <code>#</code>, игнорируются.</li>
      </ul>
      <div style="margin-top:8px" class="muted">Совет: если локально тестируешь, запусти простой сервер вместо открытия file://, например: <code>python -m http.server 8000</code> и открой <code>http://localhost:8000</code>.</div>
    </div>
  </div>

  <!-- Modal template -->
  <div id="modal" style="display:none"></div>

<script>
/* ========= parser + utils ========= */

function removeArabicDiacritics(text) {
  if (!text) return "";
  // Tashkeel + common marks
  return text.replace(/[\u0610-\u061A\u064B-\u065F\u0670\u06D6-\u06ED]/g, "");
}

function normalizeArabic(text) {
  if (!text) return "";
  let t = text.trim();
  t = removeArabicDiacritics(t);
  // آ أ إ -> ا
  t = t.replace(/[\u0622\u0623\u0625]/g, "\u0627");
  // ى -> ي
  t = t.replace(/\u0649/g, "\u064A");
  // ؤ ئ -> ء
  t = t.replace(/[\u0624\u0626]/g, "\u0621");
  // remove tatweel
  t = t.replace(/\u0640/g, "");
  return t;
}

function normalizeRussian(text) {
  if (!text) return "";
  return text.toLowerCase().trim();
}

function isCyrillic(q) {
  return /[\u0400-\u04FF]/.test(q);
}

/* parse text into entries */
function parseWordText(txt) {
  const lines = txt.split(/\r?\n/);
  const parsed = [];
  let id = 1;
  for (const raw of lines) {
    const line = raw.trim();
    if (!line || line.startsWith("#")) continue;
    let ru = "", gloss = "", ar1 = "", ar2 = "", note = "";

    if (line.includes("|")) {
      const parts = line.split("|").map(s => s.trim());
      ru = parts[0] || "";
      gloss = parts[1] || "";
      ar1 = parts[2] || "";
      ar2 = parts[3] || ar1 || "";
      note = parts[4] || "";
    } else if (line.includes(" - ")) {
      const parts = line.split(" - ").map(s => s.trim());
      const m = parts[0].match(/^(.+?)\s*\((.+)\)\s*$/);
      if (m) { ru = m[1].trim(); gloss = m[2].trim(); } else { ru = parts[0]; }
      ar1 = parts[1] || "";
      ar2 = parts[2] || removeArabicDiacritics(ar1);
    } else {
      // try tab split or whitespace
      const p = line.split(/\t+/).map(s => s.trim());
      ru = p[0] || line;
      ar1 = p[1] || "";
      ar2 = p[2] || ar1 || "";
    }

    parsed.push({
      id: id++,
      ru, gloss, ar1, ar2, note,
      _ar1_norm: normalizeArabic(ar1),
      _ar2_norm: normalizeArabic(ar2),
      _ru_norm: normalizeRussian(ru + (gloss ? (" (" + gloss + ")") : ""))
    });
  }
  return parsed;
}

/* ========= UI & app logic ========= */

const qEl = document.getElementById("q");
const resultsEl = document.getElementById("results");
const countEl = document.getElementById("count");
const modalEl = document.getElementById("modal");
const fileInput = document.getElementById("file");
const reloadBtn = document.getElementById("reload");

let entries = [];

/* render list */
function renderList(list) {
  resultsEl.innerHTML = "";
  for (const r of list) {
    const li = document.createElement("li");
    li.className = "item";
    li.tabIndex = 0;
    li.innerHTML = `<div>
                      <div class="ru">${escapeHtml(r.ru)}${r.gloss ? ' <small>(' + escapeHtml(r.gloss) + ')</small>' : ''}</div>
                      <div class="ar">${escapeHtml(r.ar1)} — ${escapeHtml(r.ar2)}</div>
                    </div>
                    <div style="font-size:13px;color:#64748b">Подробнее →</div>`;
    li.addEventListener("click", () => openModal(r));
    resultsEl.appendChild(li);
  }
  countEl.textContent = "Найдено: " + list.length;
}

/* simple HTML escape */
function escapeHtml(s) {
  if (!s) return "";
  return s.replaceAll("&", "&amp;").replaceAll("<", "&lt;").replaceAll(">", "&gt;");
}

/* search */
function search(q) {
  const qq = q.trim();
  if (!qq) return entries.slice();
  const qRu = normalizeRussian(qq);
  const qAr = normalizeArabic(qq);

  return entries.filter(e => {
    if (isCyrillic(qq)) return e._ru_norm.includes(qRu);
    if (qAr && e._ar1_norm.includes(qAr)) return true;
    if (qAr && e._ar2_norm.includes(qAr)) return true;
    if (e._ru_norm.includes(qRu)) return true;
    if (e.ar1 && e.ar1.includes(qq)) return true;
    if (e.ar2 && e.ar2.includes(qq)) return true;
    return false;
  });
}

/* modal */
function openModal(item) {
  modalEl.style.display = "block";
  modalEl.innerHTML = `<div class="modal" id="modalWrap">
    <div class="card">
      <button id="closeBtn" style="float:right">Закрыть</button>
      <h2 style="margin-top:4px">${escapeHtml(item.ru)} ${item.gloss ? '(' + escapeHtml(item.gloss) + ')' : ''}</h2>
      <div style="margin-top:8px">Арабский (с огласовками): <div class="ar">${escapeHtml(item.ar1)}</div></div>
      <div style="margin-top:8px">Арабский (без): <div class="ar">${escapeHtml(item.ar2)}</div></div>
      ${item.note ? '<div class="note">Примечание: ' + escapeHtml(item.note) + '</div>' : ''}
      <div style="margin-top:12px">
        <button id="copyBtn">Копировать запись</button>
        <button id="searchArBtn">Поиск по арабскому</button>
      </div>
    </div>
  </div>`;
  document.getElementById("closeBtn").addEventListener("click", closeModal);
  document.getElementById("copyBtn").addEventListener("click", async () => {
    const txt = `${item.ru}${item.gloss ? ' (' + item.gloss + ')' : ''} - ${item.ar1} - ${item.ar2}`;
    try { await navigator.clipboard.writeText(txt); alert("Скопировано в буфер."); } catch(e) { alert("Не удалось скопировать."); }
  });
  document.getElementById("searchArBtn").addEventListener("click", () => {
    qEl.value = item.ar2 || item.ar1;
    qEl.dispatchEvent(new Event("input", { bubbles:true }));
    closeModal();
  });
  modalEl.addEventListener("click", (ev) => { if (ev.target.id === "modalWrap") closeModal(); });
}

function closeModal() { modalEl.style.display = "none"; modalEl.innerHTML = ""; }

/* load words.txt from server */
async function loadFromServer() {
  try {
    // <-- use relative path 'words.txt' so it works when site is hosted at /repo-name/
    const res = await fetch("words.txt", { cache: "no-store" });
    if (!res.ok) throw new Error("not found");
    const txt = await res.text();
    entries = parseWordText(txt);
    renderList(entries);
  } catch (e) {
    console.warn("Не удалось загрузить words.txt:", e);
    // fallback examples
    const fallback = [
      "дом(house) - بَيْت - بيت",
      "писать(to write) - كَتَبَ - كتب",
      "кот|cat|قِطّ|قط|животное"
    ].join("\n");
    entries = parseWordText(fallback);
    renderList(entries);
  }
}

/* load from local file input */
fileInput.addEventListener("change", (ev) => {
  const f = ev.target.files && ev.target.files[0];
  if (!f) return;
  const r = new FileReader();
  r.onload = () => {
    entries = parseWordText(String(r.result || ""));
    renderList(entries);
  };
  r.readAsText(f, "utf-8");
});

reloadBtn.addEventListener("click", () => loadFromServer());

qEl.addEventListener("input", (ev) => {
  const list = search(ev.target.value);
  renderList(list);
});

/* initial load */
loadFromServer();
</script>
</body>
</html>
